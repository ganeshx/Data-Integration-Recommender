USE ROLE ACCOUNTADMIN;
  WITH 
  ROLE_GRANTS AS (
    SELECT
      PRIVILEGE,
      GRANTED_ON AS SNOWFLAKE_OBJECT_TYPE,
      TABLE_CATALOG AS DATABASE,
      TABLE_SCHEMA AS SCHEMA,
      NAME AS OBJECT_NAME,
      GRANTED_TO AS GRANTED_TO_TYPE,
      GRANTEE_NAME AS GRANTED_TO_NAME
    FROM
      SNOWFLAKE.ACCOUNT_USAGE.GRANTS_TO_ROLES
    WHERE
      DELETED_ON IS NULL
  ),
  USER_GRANTS AS (
    SELECT
    'USAGE' AS PRIVILEGE,
    'ROLE' AS SNOWFLAKE_OBJECT_TYPE,
    NULL AS DATABASE,
    NULL AS SCHEMA,
    ROLE AS OBJECT_NAME,
    GRANTED_TO AS GRANTED_TO_TYPE,
    GRANTEE_NAME AS GRANTED_TO_NAME
    FROM
      SNOWFLAKE.ACCOUNT_USAGE.GRANTS_TO_USERS
    WHERE
      DELETED_ON IS NULL
  ),
  GRANTS AS (
    SELECT * FROM ROLE_GRANTS 
    UNION ALL 
    SELECT * FROM USER_GRANTS
  ),
  GRANTS_JSON AS (
    SELECT
      OBJECT_CONSTRUCT(*) AS GRANT_OBJ
    FROM
      GRANTS
  ),
  GRANTS_JSON_ARR AS (
    SELECT
      array_agg(*) AS GRANTS
    FROM
      GRANTS_JSON
  )
  SELECT * FROM GRANTS_JSON_ARR;